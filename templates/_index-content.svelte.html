
<div class="strib-styles ssa ssb ssc">
  <div class="hero">
    <h1>Nonprofit 100</h1>

    <p class="lead container-sm">A new title for 2018 list.</p>

    <div class="byline">
      <address>By <a rel="author" href="http://startribune.com//patrick-kennedy/10645186/">Patrick Kennedy</a></address>
      <span class="spacer"></span>
      Star Tribune
      <span class="spacer-alt"></span>
      <time pubdate datetime="2018-12-30T00:00:00">December 12, 2018</time>
    </div>

    <div class="share-placeholder">
      <!-- share -->
    </div>
  </div>

  <div class="container-lg">
    <div class="category-filter">
      <form>
        <div class="row">
          <div class="col col-100 col-md-66">
            <fieldset>
              <legend>Filter <span class="sr-only">company list</span></legend>

              {#each categories as f}
                <button type="button" class="category { f.id } { categoryFilter === f.id ? 'active' : '' }" on:click="proxySet(event, { categoryFilter: f.id })">{ f.name }</button>
              {/each}
            </fieldset>
          </div>

          <div class="col col-100 col-md-33">
            <div class="ceo-sort">
              {#if (!ceoSort)}
                <button on:click="proxySet(event, { ceoSort: true })" type="button" class="sort-ceo">Sort by CEO compensation</button>
              {:else}
                <button on:click="proxySet(event, { ceoSort: false })" type="button" class="unsort-ceo">Sort by revenue rankings</button>
              {/if}
            </div>
          </div>
      </form>
    </div>

    <div class="company-list">
      {#each filteredNonProfits as company}
        <Company
          {...company}
          publishYear="{ publishYear }"
          ceoTitleMatch="{ ceoTitleMatch }"
        />
      {/each}
    </div>
  </div>
</div>

<script>
  import Company from "./_company.svelte.html";
  import { cloneDeep, sortBy, filter, kebabCase, find } from "lodash";

  export default {
    components: {
      Company
    },

    computed: {
      filteredNonProfits({
        nonprofits,
        categoryFilter,
        ceoSort,
        publishYear,
        ceoTitleMatch
      }) {
        let copy = cloneDeep(nonprofits);

        // Filter
        if (categoryFilter) {
          copy = filter(copy, c => {
            return kebabCase(c.category) === categoryFilter;
          });
        }

        // Sort
        if (ceoSort) {
          copy = sortBy(copy, c => {
            let ceo = find(c.officers, ceoTitleMatch);
            if (ceo) {
              let sal = find(ceo.nonprofit_salaries, {
                publishyear: publishYear
              });

              if (sal) {
                return sal.total || 0;
              }
            }

            return 0;
          }).reverse();
        }

        return copy;
      }
    },

    methods: {
      proxySet(event, toSet) {
        if (event && event.preventDefault) {
          event.preventDefault();
        }

        if (toSet) {
          this.set(toSet);
        }
      }
    },

    data() {
      return {
        filter: undefined,
        ceoTitleMatch: officer => {
          return (
            officer.ceo ||
            (officer.title &&
              officer.title.match(/(ceo|president|chief\s+execut)/i))
          );
        },
        categories: [
          { id: undefined, name: "All" },
          { id: "social-services", name: "Social services" },
          { id: "healthcare", name: "Healthcare" },
          { id: "arts", name: "Arts" },
          { id: "education", name: "Education" },
          { id: "other", name: "Other" }
        ]
      };
    }
  };
</script>
